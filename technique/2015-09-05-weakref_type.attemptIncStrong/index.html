<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Boxcounter的烂笔头</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen">
    <link rel="stylesheet" href="/css/hugo-bootswatch.css">
  </head>
  <body>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand">Boxcounter的烂笔头</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-right">
           <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="sections">Sections<span class="caret"></span></a>
              <ul class="dropdown-menu" aria-labelledby="download">
              
                <li><a href="/"></a></li>
              
                <li><a href="/essay">essay</a></li>
              
                <li><a href="/reading">reading</a></li>
              
                <li><a href="/technique">technique</a></li>
              
              </ul>
            </li> 
          </ul>
        </div>
      </div>
    </div>


    <div class="container">
        <h1><a href="http://boxcounter.com/technique/2015-09-05-weakref_type.attemptincstrong/">RefBase::weakref_type::attemptIncStrong的理解</a></h1>
        <hr />
        <span class="post-time">2015-09-05</span>

        <div class="post">
            <p>见中文注释内容：</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #2b91af">bool</span> RefBase::weakref_type::attemptIncStrong(<span style="color: #0000ff">const</span> <span style="color: #2b91af">void</span>* id)
{
    incWeak(id);
    
    weakref_impl* <span style="color: #0000ff">const</span> impl = <span style="color: #0000ff">static_cast</span>&lt;weakref_impl*&gt;(<span style="color: #0000ff">this</span>);
    
    <span style="color: #2b91af">int32_t</span> curCount = impl-&gt;mStrong;
    LOG_ASSERT(curCount &gt;= 0, <span style="color: #a31515">&quot;attemptIncStrong called on %p after underflow&quot;</span>,
               <span style="color: #0000ff">this</span>);
    <span style="color: #0000ff">while</span> (curCount &gt; 0 &amp;&amp; curCount != INITIAL_STRONG_VALUE) {
        <span style="color: #0000ff">if</span> (android_atomic_cmpxchg(curCount, curCount+1, &amp;impl-&gt;mStrong) == 0) {
            <span style="color: #0000ff">break</span>;
        }
        curCount = impl-&gt;mStrong;
    }
    
    <span style="color: #0000ff">if</span> (curCount &lt;= 0 || curCount == INITIAL_STRONG_VALUE) {
        <span style="color: #2b91af">bool</span> allow;
        <span style="color: #0000ff">if</span> (curCount == INITIAL_STRONG_VALUE) {
            <span style="color: #008000">// Attempting to acquire first strong reference...  this is allowed</span>
            <span style="color: #008000">// if the object does NOT have a longer lifetime (meaning the</span>
            <span style="color: #008000">// implementation doesn&#39;t need to see this), or if the implementation</span>
            <span style="color: #008000">// allows it to happen.</span>
            <span style="color: #008000">//</span>
            <span style="color: #008000">// ====&gt;</span>
            <span style="color: #008000">// 未曾被强引用过，如果也不受弱引用影响，那肯定还未被销毁。</span>
            <span style="color: #008000">// &lt;====</span>
            <span style="color: #008000">//</span>
            allow = (impl-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) != OBJECT_LIFETIME_WEAK
                  || impl-&gt;mBase-&gt;onIncStrongAttempted(FIRST_INC_STRONG, id);
        } <span style="color: #0000ff">else</span> {
            <span style="color: #008000">// Attempting to revive the object...  this is allowed</span>
            <span style="color: #008000">// if the object DOES have a longer lifetime (so we can safely</span>
            <span style="color: #008000">// call the object with only a weak ref) and the implementation</span>
            <span style="color: #008000">// allows it to happen.</span>
            <span style="color: #008000">//</span>
            <span style="color: #008000">// ====&gt;</span>
            <span style="color: #008000">// 曾经被强引用过，如果不受弱引用影响，那么在RefBase.decStrong()中已经被销毁了，无法revive。</span>
            <span style="color: #008000">// 所以，一定要受弱引用影响。</span>
            <span style="color: #008000">// &lt;====</span>
            <span style="color: #008000">//</span>
            allow = (impl-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) == OBJECT_LIFETIME_WEAK
                  &amp;&amp; impl-&gt;mBase-&gt;onIncStrongAttempted(FIRST_INC_STRONG, id);
        }
        <span style="color: #0000ff">if</span> (!allow) {
            decWeak(id);
            <span style="color: #0000ff">return</span> false;
        }
        curCount = android_atomic_inc(&amp;impl-&gt;mStrong);
        <span style="color: #008000">// If the strong reference count has already been incremented by</span>
        <span style="color: #008000">// someone else, the implementor of onIncStrongAttempted() is holding</span>
        <span style="color: #008000">// an unneeded reference.  So call onLastStrongRef() here to remove it.</span>
        <span style="color: #008000">// (No, this is not pretty.)  Note that we MUST NOT do this if we</span>
        <span style="color: #008000">// are in fact acquiring the first reference.</span>
        <span style="color: #0000ff">if</span> (curCount &gt; 0 &amp;&amp; curCount &lt; INITIAL_STRONG_VALUE) {
            impl-&gt;mBase-&gt;onLastStrongRef(id);
        }
    }
    
    impl-&gt;addWeakRef(id);
    impl-&gt;addStrongRef(id);
<span style="color: #0000ff">#if PRINT_REFS</span>
    LOGD(<span style="color: #a31515">&quot;attemptIncStrong of %p from %p: cnt=%d\n&quot;</span>, <span style="color: #0000ff">this</span>, id, curCount);
<span style="color: #0000ff">#endif</span>
    <span style="color: #0000ff">if</span> (curCount == INITIAL_STRONG_VALUE) {
        android_atomic_add(-INITIAL_STRONG_VALUE, &amp;impl-&gt;mStrong);
        impl-&gt;mBase-&gt;onFirstRef();
    }
    
    <span style="color: #0000ff">return</span> true;
}
</pre></div>


<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #2b91af">void</span> RefBase::decStrong(<span style="color: #0000ff">const</span> <span style="color: #2b91af">void</span>* id) <span style="color: #0000ff">const</span>
{
    weakref_impl* <span style="color: #0000ff">const</span> refs = mRefs;
    refs-&gt;removeStrongRef(id);
    <span style="color: #0000ff">const</span> <span style="color: #2b91af">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);
<span style="color: #0000ff">#if PRINT_REFS</span>
    LOGD(<span style="color: #a31515">&quot;decStrong of %p from %p: cnt=%d\n&quot;</span>, <span style="color: #0000ff">this</span>, id, c);
<span style="color: #0000ff">#endif</span>
    LOG_ASSERT(c &gt;= 1, <span style="color: #a31515">&quot;decStrong() called on %p too many times&quot;</span>, refs);
    <span style="color: #0000ff">if</span> (c == 1) {
        <span style="color: #0000ff">const_cast</span>&lt;RefBase*&gt;(<span style="color: #0000ff">this</span>)-&gt;onLastStrongRef(id);
        <span style="color: #0000ff">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) != OBJECT_LIFETIME_WEAK) {
            <span style="color: #0000ff">if</span> (refs-&gt;mDestroyer) {
                refs-&gt;mDestroyer-&gt;destroy(<span style="color: #0000ff">this</span>);
            } <span style="color: #0000ff">else</span> {
                <span style="color: #0000ff">delete</span> <span style="color: #0000ff">this</span>;
            }
        }
    }
    refs-&gt;removeWeakRef(id);
    refs-&gt;decWeak(id);
}
</pre></div>
</p>

<hr />

<p>完整代码：</p>

<ul>
<li><a href="https://android.googlesource.com/platform/frameworks/base/+/gingerbread/include/utils/RefBase.h">RefBase.h</a></li>
<li><a href="https://android.googlesource.com/platform/frameworks/base/+/gingerbread/libs/utils/RefBase.cpp">RefBase.cpp</a></li>
</ul>

        </div>

              
<footer>
  <div class="pull-right small text-muted">Power by <a href="https://gohugo.io/">Hugo</a> and Theme by <a href="Hugo">Bootswatch</a></div>
</footer>

     </div>

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/bootswatch.js"></script>
    </body>
</html>


